name: Count Lines of Code

on:
  schedule:
    - cron: '0 0 * * 0' # Run every Sunday at midnight
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  count-lines:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Install cloc
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc
          
      - name: Get all repos
        id: repos
        run: |
          # Check if PAT_TOKEN is available for private repos
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "‚úÖ Using PAT_TOKEN to access all repositories (public + private)"
            TOKEN="${{ secrets.PAT_TOKEN }}"
          else
            echo "‚ö†Ô∏è Using GITHUB_TOKEN (public repos only)"
            echo "To count private repos, add a PAT_TOKEN secret. See PAT-SETUP.md"
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
          fi
          
          # Get personal repos
          echo "Fetching personal repositories..."
          curl -H "Authorization: token $TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/user/repos?per_page=100&affiliation=owner" > personal_repos.json
          
          # Get RoboNexus org repos
          echo "Fetching RoboNexus organization repositories..."
          curl -H "Authorization: token $TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/orgs/RoboNexxus/repos?per_page=100" > org_repos.json
          
          # Combine both lists
          echo "Combining repository lists..."
          
          # Extract personal repo names
          if jq -e 'type == "array"' personal_repos.json > /dev/null 2>&1; then
            jq -r '.[] | "AtharvM02222/\(.name)"' personal_repos.json > repo_list.txt
            personal_count=$(wc -l < repo_list.txt)
            echo "‚úÖ Found $personal_count personal repositories"
          else
            echo "‚ùå Failed to get personal repos"
            cat personal_repos.json
            touch repo_list.txt
          fi
          
          # Extract org repo names and append
          if jq -e 'type == "array"' org_repos.json > /dev/null 2>&1; then
            jq -r '.[] | "RoboNexxus/\(.name)"' org_repos.json >> repo_list.txt
            org_count=$(jq -r 'length' org_repos.json)
            echo "‚úÖ Found $org_count RoboNexus organization repositories"
          else
            echo "‚ö†Ô∏è Could not access RoboNexus org repos (might need read:org scope)"
          fi
          
          total_repos=$(wc -l < repo_list.txt)
          echo ""
          echo "üìä Total repositories to process: $total_repos"
          echo "Repositories:"
          cat repo_list.txt
          
      - name: Clone and count lines
        env:
          TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          total_lines=0
          total_code=0
          total_comments=0
          total_blanks=0
          repo_count=0
          
          # Create temp directory
          mkdir -p temp_repos
          
          # Clone each repo and count lines
          while IFS= read -r repo; do
            echo "Processing $repo..."
            git clone https://x-access-token:${TOKEN}@github.com/$repo.git temp_repos/$repo 2>/dev/null || continue
            
            # Count lines using cloc
            cloc temp_repos/$repo --json --quiet > cloc_output.json 2>/dev/null || continue
            
            # Extract totals
            code=$(cat cloc_output.json | jq -r '.SUM.code // 0')
            comments=$(cat cloc_output.json | jq -r '.SUM.comment // 0')
            blanks=$(cat cloc_output.json | jq -r '.SUM.blank // 0')
            
            if [ "$code" -gt 0 ]; then
              total_code=$((total_code + code))
              total_comments=$((total_comments + comments))
              total_blanks=$((total_blanks + blanks))
              repo_count=$((repo_count + 1))
              echo "  ‚úì $repo: $code lines of code"
            fi
            
            # Clean up
            rm -rf temp_repos/$repo
          done < repo_list.txt
          
          total_lines=$((total_code + total_comments + total_blanks))
          
          # Format numbers with commas
          formatted_lines=$(printf "%'d" $total_lines)
          formatted_code=$(printf "%'d" $total_code)
          
          echo "TOTAL_LINES=$formatted_lines" >> $GITHUB_ENV
          echo "TOTAL_CODE=$formatted_code" >> $GITHUB_ENV
          echo "REPO_COUNT=$repo_count" >> $GITHUB_ENV
          
          echo "================================"
          echo "Total Lines: $formatted_lines"
          echo "Code Lines: $formatted_code"
          echo "Comments: $total_comments"
          echo "Blanks: $total_blanks"
          echo "Repositories: $repo_count"
          echo "================================"
          
      - name: Update README
        run: |
          # Update the README with the new counts
          sed -i "s/Total_Lines-Calculating\.\.\.-00d9ff/Total_Lines-${{ env.TOTAL_LINES }}-00d9ff/g" README.md
          sed -i "s/Repositories-28-00d9ff/Repositories-${{ env.REPO_COUNT }}-00d9ff/g" README.md
          sed -i "s/Across all repositories/Across all ${{ env.REPO_COUNT }} repositories/g" README.md
          
          # Show what changed
          echo "Updated README with:"
          echo "  Total Lines: ${{ env.TOTAL_LINES }}"
          echo "  Repositories: ${{ env.REPO_COUNT }}"
          
      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "üìä Update lines of code count: ${{ env.TOTAL_LINES }} lines across ${{ env.REPO_COUNT }} repos" && git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} HEAD:main)
