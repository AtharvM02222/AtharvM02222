name: Count Lines of Code

on:
  schedule:
    - cron: '0 0 * * 0' # Run every Sunday at midnight
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  count-lines:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Install cloc
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc
          
      - name: Get all repos
        id: repos
        run: |
          # Check if PAT_TOKEN is available for private repos
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "Using PAT_TOKEN to access all repositories (public + private)"
            TOKEN="${{ secrets.PAT_TOKEN }}"
          else
            echo "Using GITHUB_TOKEN (public repos only)"
            echo "âš ï¸ To count private repos, add a PAT_TOKEN secret. See PAT-SETUP.md"
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
          fi
          
          # Use GraphQL API to get all repos
          curl -H "Authorization: bearer $TOKEN" \
               -H "Content-Type: application/json" \
               -X POST \
               -d '{"query":"query { viewer { repositories(first: 100, affiliations: OWNER, privacy: PUBLIC) { nodes { name } } } }"}' \
               https://api.github.com/graphql > repos.json
          
          # Debug: Show API response
          echo "API Response:"
          cat repos.json
          
          # Extract repo names from GraphQL response
          if jq -e '.data.viewer.repositories.nodes' repos.json > /dev/null 2>&1; then
            jq -r '.data.viewer.repositories.nodes[].name' repos.json > repo_list.txt
            echo "Successfully extracted $(wc -l < repo_list.txt) repositories"
            cat repo_list.txt
          else
            echo "ERROR: GraphQL API failed."
            cat repos.json
            exit 1
          fi
          
      - name: Clone and count lines
        env:
          TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          total_lines=0
          total_code=0
          total_comments=0
          total_blanks=0
          repo_count=0
          
          # Create temp directory
          mkdir -p temp_repos
          
          # Clone each repo and count lines
          while IFS= read -r repo; do
            echo "Processing $repo..."
            git clone https://x-access-token:${TOKEN}@github.com/AtharvM02222/$repo.git temp_repos/$repo 2>/dev/null || continue
            
            # Count lines using cloc
            cloc temp_repos/$repo --json --quiet > cloc_output.json 2>/dev/null || continue
            
            # Extract totals
            code=$(cat cloc_output.json | jq -r '.SUM.code // 0')
            comments=$(cat cloc_output.json | jq -r '.SUM.comment // 0')
            blanks=$(cat cloc_output.json | jq -r '.SUM.blank // 0')
            
            if [ "$code" -gt 0 ]; then
              total_code=$((total_code + code))
              total_comments=$((total_comments + comments))
              total_blanks=$((total_blanks + blanks))
              repo_count=$((repo_count + 1))
              echo "  âœ“ $repo: $code lines of code"
            fi
            
            # Clean up
            rm -rf temp_repos/$repo
          done < repo_list.txt
          
          total_lines=$((total_code + total_comments + total_blanks))
          
          # Format numbers with commas
          formatted_lines=$(printf "%'d" $total_lines)
          formatted_code=$(printf "%'d" $total_code)
          
          echo "TOTAL_LINES=$formatted_lines" >> $GITHUB_ENV
          echo "TOTAL_CODE=$formatted_code" >> $GITHUB_ENV
          echo "REPO_COUNT=$repo_count" >> $GITHUB_ENV
          
          echo "================================"
          echo "Total Lines: $formatted_lines"
          echo "Code Lines: $formatted_code"
          echo "Comments: $total_comments"
          echo "Blanks: $total_blanks"
          echo "Repositories: $repo_count"
          echo "================================"
          
      - name: Update README
        run: |
          # Update the README with the new counts
          sed -i "s/Total_Lines-Calculating\.\.\.-00d9ff/Total_Lines-${{ env.TOTAL_LINES }}-00d9ff/g" README.md
          sed -i "s/Repositories-28-00d9ff/Repositories-${{ env.REPO_COUNT }}-00d9ff/g" README.md
          sed -i "s/Across all repositories/Across all ${{ env.REPO_COUNT }} repositories/g" README.md
          
          # Show what changed
          echo "Updated README with:"
          echo "  Total Lines: ${{ env.TOTAL_LINES }}"
          echo "  Repositories: ${{ env.REPO_COUNT }}"
          
      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ“Š Update lines of code count: ${{ env.TOTAL_LINES }} lines across ${{ env.REPO_COUNT }} repos" && git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} HEAD:main)
